# qmd Setup Guide

Complete setup for qmd with Claude Code auto-indexing and overnight embedding refresh.

## How Indexing Works

qmd has two separate indexes that serve different search modes:

| Index | Command | Speed | Enables | When to run |
|-------|---------|-------|---------|-------------|
| **Text index** | `qmd update` | ~1 sec | `search` (BM25 keyword matching) | After every file change |
| **Embeddings** | `qmd embed` | ~3-4 min | `vsearch` (semantic similarity), `query` (hybrid) | Daily or after big changes |

**The text index** is a BM25 full-text index. It's fast to rebuild and handles 90% of queries well. Any time a file changes, you want this updated immediately so search results stay current.

**Embeddings** are vector representations of each text chunk, generated by a local ML model. They enable semantic search (finding conceptually related content even without keyword matches). They're expensive to compute - regenerating all embeddings takes several minutes - so you only want to do this periodically.

**The automation strategy:**
1. **Claude Code hook** (PostToolUse on Edit/Write) - runs `qmd update` in the background after every file edit. Keeps keyword search always fresh. Invisible, ~1 second.
2. **launchd job** (daily at midnight) - runs `qmd update && qmd embed`. Refreshes embeddings overnight when you're not working. If Mac is asleep at midnight, runs when it wakes.
3. **fswatch** (optional) - for edits made outside Claude Code (e.g. Obsidian). Watches the directory and runs `qmd update` on changes.

This means keyword search (`qmd search`) is always up-to-date, and semantic search (`qmd vsearch`) is at most ~24 hours stale. For most use cases that's fine - you're not usually doing semantic search for content you just wrote.

## 1. Install qmd

Requires [Bun](https://bun.sh) and Homebrew's SQLite.

```bash
# Install bun (if not installed)
curl -fsSL https://bun.sh/install | bash

# Install SQLite (macOS)
brew install sqlite

# Install qmd globally
bun install -g github:tobi/qmd

# Verify
qmd --help
```

Make sure `~/.bun/bin` is in your PATH. Add to `~/.zshrc` if not:

```bash
export PATH="$HOME/.bun/bin:$PATH"
```

## 2. Index a Collection

```bash
# Add a directory of markdown files
qmd collection add /path/to/your/docs --name my-project

# Index it
qmd update

# Generate embeddings for semantic search
qmd embed

# Verify
qmd status
```

## 3. Auto-Index on File Edits (Claude Code Hook)

This hook runs `qmd update` in the background every time Claude edits or writes a markdown file in your project.

### Create the hook script

Copy the template and customize the path:

```bash
cp ~/.claude/skills/qmd/templates/hook.sh ~/.claude/hooks/qmd-update.sh
chmod +x ~/.claude/hooks/qmd-update.sh
```

Edit `~/.claude/hooks/qmd-update.sh` and change the project path:

```bash
# Change this to match your project directory
PROJECT_DIR="/path/to/your/project"
```

### Add to Claude Code settings

Add to `~/.claude/settings.json` (merge with existing hooks if present):

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Edit",
        "hooks": [
          {
            "type": "command",
            "command": "bash ~/.claude/hooks/qmd-update.sh"
          }
        ]
      },
      {
        "matcher": "Write",
        "hooks": [
          {
            "type": "command",
            "command": "bash ~/.claude/hooks/qmd-update.sh"
          }
        ]
      }
    ]
  }
}
```

## 4. Overnight Embedding Refresh (launchd)

Embeddings are expensive to compute. This launchd job runs daily at midnight to refresh them.

### Install the launchd job

Copy the template and customize:

```bash
cp ~/.claude/skills/qmd/templates/launchd.plist ~/Library/LaunchAgents/com.qmd-embed.plist
```

Edit `~/Library/LaunchAgents/com.qmd-embed.plist` - update the qmd binary path if needed (default: `~/.bun/bin/qmd`).

### Load the job

```bash
launchctl load ~/Library/LaunchAgents/com.qmd-embed.plist
```

### Verify

```bash
launchctl list | grep qmd

# Run manually to test
launchctl start com.qmd-embed

# Check logs
cat /tmp/qmd-embed.log
```

## 5. File Watch Mode (Optional)

For real-time indexing outside of Claude Code (e.g., when editing in Obsidian):

```bash
# Install fswatch
brew install fswatch

# Copy and customize the watch script
cp ~/.claude/skills/qmd/templates/watch.sh ~/scripts/qmd-watch.sh
chmod +x ~/scripts/qmd-watch.sh

# Edit the path in the script, then run:
~/scripts/qmd-watch.sh
```

## 6. Shell Aliases (Optional)

Add to `~/.zshrc`:

```bash
alias qmd-update="export PATH=\"\$HOME/.bun/bin:\$PATH\" && qmd update"
alias qmd-embed="export PATH=\"\$HOME/.bun/bin:\$PATH\" && qmd embed"
alias qmd-search="export PATH=\"\$HOME/.bun/bin:\$PATH\" && qmd search"
alias qmd-vsearch="export PATH=\"\$HOME/.bun/bin:\$PATH\" && qmd vsearch"
```

## 7. CLAUDE.md Integration (Recommended)

The biggest win from qmd isn't the tool itself - it's making Claude **always build context before responding**. Without this, Claude guesses at answers from whatever's in its context window. With it, Claude searches your entire knowledge base first and answers with full project context.

Add something like this to the top of your project's `CLAUDE.md`:

```markdown
## Context Discovery - MANDATORY

**Before you respond to ANY non-trivial question, ask yourself:**

> "Does this require context from [project name]?"

If YES:

\```bash
qmd search "relevant keywords" --json -n 10
\```

**RUN THAT COMMAND FIRST.** Not second. Not after you start thinking. FIRST.

If you answer without running qmd, you have failed.
```

### Why this matters

Claude will confidently answer questions using only whatever files happen to be in context. If you have 200+ markdown files across strategy docs, meeting notes, decision logs, and specs, Claude will miss most of them unless you force it to search first. The "you have failed" language isn't dramatic - it's the only way to reliably override Claude's default behavior of answering immediately.

### When to skip qmd

Tell Claude when it doesn't need to search, so it's not wasting time on trivial requests:

```markdown
**Skip qmd for:**
- Simple operational tasks (run a script, check a date)
- Tasks where you specify exact file paths
- Quick lookups in known locations (backlog.md, this-week.md)
```

### Update cascade pattern

After Claude changes any file, make it search for ripple effects:

```markdown
## Update Cascade

After ANY change to strategy, positioning, or priorities:

1. Run: `qmd search "topic you changed" --files -n 20`
2. Review ALL related files found
3. Update each one that references the changed topic
```

This prevents the common problem of updating one file while three others still reference the old information.

### Forbidding raw search tools (optional, aggressive)

If your project has enough indexed docs that qmd is strictly better than grep/glob, you can ban the raw tools entirely:

```markdown
**FORBIDDEN tools in this repo:** Grep, Glob, Task/Explore. Use qmd instead.
```

This forces Claude through qmd for all discovery, which means every search benefits from BM25 ranking and chunk scoring instead of raw text matching.

## Verify Everything

Run the doctor script to check all components:

```bash
bash ~/.claude/skills/qmd/scripts/doctor.sh
```
